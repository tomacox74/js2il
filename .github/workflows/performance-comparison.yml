name: Performance Comparison

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to run performance tests on'
        required: false
        default: 'master'
  pull_request:
    types: [ opened ]
    branches: [ "master" ]

jobs:
  performance-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      
      - name: Build JS2IL
        run: |
          dotnet build -c Release
          dotnet pack -c Release
      
      - name: Install JS2IL as global tool
        run: |
          dotnet tool install --global --add-source ./Js2IL/bin/Release js2il
      
      - name: Build Jint Comparison Project
        run: |
          cd tests/performance/JintComparison
          dotnet build -c Release
      
      - name: Shutdown build server
        run: |
          # Kill VBCSCompiler and other build processes to free up resources
          # before running performance benchmarks
          dotnet build-server shutdown

      - name: Run Performance Comparison
        id: perf
        run: |
          cd tests/performance
          node RunComparison.js | tee results.txt
          cat results.txt
      
      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: tests/performance/results.txt
          retention-days: 30
      
      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request' || github.event.pull_request
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let results = fs.readFileSync('tests/performance/results.txt', 'utf8');
            
            // Strip ANSI color codes for clean markdown display
            results = results.replace(/\x1b\[[0-9;]*m/g, '');
            
            const comment = `## ðŸš€ Performance Comparison Results
            
            \`\`\`
            ${results}
            \`\`\`
            
            *Run on: ${new Date().toISOString()}*
            *Workflow: [${context.workflow}](${context.payload.repository.html_url}/actions/runs/${context.runId})*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
