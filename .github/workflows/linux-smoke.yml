name: linux-smoke

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  smoke:
    runs-on: ubuntu-latest
    env:
      DOTNET_NOLOGO: true
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Need full history to read tags for determining the latest release version
          fetch-depth: 0

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Determine js2il tool version
        run: |
          set -euo pipefail
          # Use the highest semver-like tag (vX.Y.Z[-suffix]) available
          tag=$(git tag --sort=-v:refname | head -n1)
          version="${tag#v}"
          echo "Using tool version: $version"
          echo "TOOL_VERSION=$version" >> "$GITHUB_ENV"

      - name: Install js2il tool from NuGet (specific version with retry)
        run: |
          set -euo pipefail
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH
          tries=20
          delay=30
          for i in $(seq 1 $tries); do
            if dotnet tool install --global js2il --version "$TOOL_VERSION"; then
              echo "Installed js2il $TOOL_VERSION"
              exit 0
            fi
            echo "Attempt $i/$tries: js2il $TOOL_VERSION not available yet on NuGet; waiting ${delay}s..."
            sleep $delay
          done
          echo "Failed to install js2il $TOOL_VERSION from NuGet after $tries attempts" >&2
          exit 1

      - name: Show js2il version
        run: |
          # Older previews may not support --version; fall back to help
          js2il --version || js2il -h || true

      - name: Convert tests/simple.js to IL
        run: js2il tests/simple.js -o out

      - name: Run generated assembly and verify output
        run: |
          set -e
          output=$(dotnet out/simple.dll)
          echo "Program output:" 
          echo "$output"
          if ! echo "$output" | grep -i "x is"; then
            echo "Smoke test failed: expected output containing 'x is'"
            exit 1
          fi
