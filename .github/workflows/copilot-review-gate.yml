name: copilot-review-gate

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review_thread:
    types: [resolved, unresolved]

permissions:
  pull-requests: read

jobs:
  copilot-review:
    runs-on: ubuntu-latest
    steps:
      - name: Fail if Copilot threads unresolved
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            // pull_request_review_thread event payload shape differs; fall back to context.issue
            const prNumber = pr?.number ?? context.issue.number;

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const COPILOT_LOGIN = 'copilot-pull-request-reviewer';

            async function fetchAllThreads() {
              let after = null;
              const threads = [];

              while (true) {
                const result = await github.graphql(
                  `query($owner: String!, $repo: String!, $number: Int!, $after: String) {
                    repository(owner: $owner, name: $repo) {
                      pullRequest(number: $number) {
                        reviewThreads(first: 100, after: $after) {
                          pageInfo { hasNextPage endCursor }
                          nodes {
                            id
                            isResolved
                            isOutdated
                            comments(last: 20) {
                              nodes {
                                author { login }
                                url
                              }
                            }
                          }
                        }
                      }
                    }
                  }`,
                  { owner, repo, number: prNumber, after }
                );

                const rt = result.repository.pullRequest.reviewThreads;
                threads.push(...rt.nodes);

                if (!rt.pageInfo.hasNextPage) break;
                after = rt.pageInfo.endCursor;
              }

              return threads;
            }

            const threads = await fetchAllThreads();

            const unresolvedCopilotThreads = threads.filter(t => {
              if (t.isResolved) return false;
              return (t.comments?.nodes ?? []).some(c => c?.author?.login === COPILOT_LOGIN);
            });

            if (unresolvedCopilotThreads.length === 0) {
              core.info('No unresolved Copilot review threads found.');
              return;
            }

            const links = unresolvedCopilotThreads
              .map(t => (t.comments?.nodes ?? []).find(c => c?.author?.login === COPILOT_LOGIN)?.url)
              .filter(Boolean);

            core.setFailed(
              `Unresolved Copilot review threads: ${unresolvedCopilotThreads.length}` +
              (links.length ? `\n\n${links.join('\n')}` : '')
            );
