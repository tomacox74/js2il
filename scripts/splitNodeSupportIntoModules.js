#!/usr/bin/env node
"use strict";

/**
 * Splits docs/nodejs/NodeSupport.json into individual module/global JSON files.
 * Creates one file per module and one file per global.
 * Files are named after the module/global name with special characters replaced.
 * 
 * Usage:
 *   node scripts/splitNodeSupportIntoModules.js
 */

const fs = require('fs');
const path = require('path');

function sanitizeFileName(name) {
  // Replace special characters with underscores for file names
  // e.g., "fs/promises" -> "fs_promises", "console.log" -> "console_log"
  return name.replace(/[\/\.]/g, '_');
}

function createModuleDoc(module, nodeVersionTarget) {
  return {
    "$schema": "./ModuleDoc.schema.json",
    "autoGeneratedHeader": false,
    "name": module.name,
    "type": "module",
    "status": module.status,
    "docsUrl": module.docs,
    "nodeVersionTarget": nodeVersionTarget,
    "implementation": module.implementation,
    "apis": module.apis || []
  };
}

function createGlobalDoc(global, nodeVersionTarget) {
  return {
    "$schema": "./ModuleDoc.schema.json",
    "autoGeneratedHeader": false,
    "name": global.name,
    "type": "global",
    "status": global.status,
    "docsUrl": global.docs,
    "nodeVersionTarget": nodeVersionTarget,
    "implementation": global.implementation,
    "notes": global.notes,
    "tests": global.tests || []
  };
}

function main() {
  const repoRoot = path.resolve(__dirname, '..');
  const nodejsDir = path.join(repoRoot, 'docs', 'nodejs');
  const jsonPath = path.join(nodejsDir, 'NodeSupport.json');
  
  if (!fs.existsSync(jsonPath)) {
    console.error(`Error: ${jsonPath} not found`);
    process.exit(1);
  }

  const nodeSupport = JSON.parse(fs.readFileSync(jsonPath, 'utf8'));
  const { nodeVersionTarget, modules, globals, limitations } = nodeSupport;

  let created = 0;
  let skipped = 0;

  // Process modules
  console.log('\nProcessing modules...');
  for (const module of modules || []) {
    const fileName = sanitizeFileName(module.name) + '.json';
    const filePath = path.join(nodejsDir, fileName);
    
    const doc = createModuleDoc(module, nodeVersionTarget);
    const json = JSON.stringify(doc, null, 2) + '\n';
    
    if (fs.existsSync(filePath)) {
      const existing = fs.readFileSync(filePath, 'utf8');
      if (existing === json) {
        console.log(`  ✓ ${fileName} (unchanged)`);
        skipped++;
        continue;
      }
    }
    
    fs.writeFileSync(filePath, json, 'utf8');
    console.log(`  ✓ ${fileName} (created)`);
    created++;
  }

  // Process globals
  console.log('\nProcessing globals...');
  for (const global of globals || []) {
    const fileName = sanitizeFileName(global.name) + '.json';
    const filePath = path.join(nodejsDir, fileName);
    
    const doc = createGlobalDoc(global, nodeVersionTarget);
    const json = JSON.stringify(doc, null, 2) + '\n';
    
    if (fs.existsSync(filePath)) {
      const existing = fs.readFileSync(filePath, 'utf8');
      if (existing === json) {
        console.log(`  ✓ ${fileName} (unchanged)`);
        skipped++;
        continue;
      }
    }
    
    fs.writeFileSync(filePath, json, 'utf8');
    console.log(`  ✓ ${fileName} (created)`);
    created++;
  }

  // Save limitations to a separate file
  console.log('\nProcessing limitations...');
  const limitationsPath = path.join(nodejsDir, 'NodeLimitations.json');
  const limitationsDoc = {
    nodeVersionTarget,
    limitations: limitations || []
  };
  const limitationsJson = JSON.stringify(limitationsDoc, null, 2) + '\n';
  fs.writeFileSync(limitationsPath, limitationsJson, 'utf8');
  console.log(`  ✓ NodeLimitations.json (created)`);

  console.log(`\nSummary: Created ${created} files, ${skipped} unchanged`);
  console.log(`\nNext steps:`);
  console.log(`  1. Review generated files in ${path.relative(repoRoot, nodejsDir)}/`);
  console.log(`  2. Run: node scripts/generateNodeIndex.js`);
  console.log(`  3. Run: node scripts/generateNodeModuleDocs.js`);
}

main();
